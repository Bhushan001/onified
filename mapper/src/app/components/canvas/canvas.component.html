<div 
  class="canvas-container"
  [class.drag-over]="isDragOver"
  #canvasContainer
  (click)="onCanvasClick($event)"
  (mousedown)="onCanvasMouseDown($event)"
  (dragenter)="onCanvasDragEnter($event)"
  (dragleave)="onCanvasDragLeave($event)"
  (dragover)="onCanvasDragOver($event)"
  (drop)="onCanvasDrop($event)"
  (wheel)="onZoom($event)"
  (contextmenu)="onContextMenuClose()"
>
  <!-- N8N-style Canvas Background -->
  <div class="canvas-background" (mousedown)="onCanvasMouseDown($event)">
    <div class="grid-dots" (mousedown)="onCanvasMouseDown($event)"></div>
  </div>

  <!-- Canvas Content -->
  <div class="canvas-content" [style.transform]="getCanvasTransform()">
    <!-- Render Nodes -->
    <app-node
      *ngFor="let node of canvasState.nodes"
      [node]="node"
      (nodeSelect)="onNodeSelect($event)"
      (nodeMouseDown)="onNodeMouseDown($event.nodeId, $event.event)"
      (nodeDelete)="onNodeDelete($event)"
      (nodeDoubleClick)="onNodeDoubleClickHandler($event)"
      (nodeContextMenu)="onNodeContextMenu($event.nodeId, $event.event)"
    ></app-node>

    <!-- Render Connections (SVG) -->
    <svg class="connections-layer" *ngIf="canvasState.connections.length > 0">
      <defs>
        <marker
          id="arrowhead"
          markerWidth="10"
          markerHeight="7"
          refX="9"
          refY="3.5"
          orient="auto"
        >
          <polygon
            points="0 0, 10 3.5, 0 7"
            fill="#999"
          />
        </marker>
      </defs>
      
      <path
        *ngFor="let connection of canvasState.connections"
        class="connection-path"
        [attr.d]="getConnectionPath(connection)"
        marker-end="url(#arrowhead)"
      />
    </svg>
  </div>

  <!-- Canvas Controls -->
  <div class="canvas-controls">
    <button 
      class="control-btn"
      (click)="onZoomIn()"
      title="Zoom In"
    >
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
      </svg>
    </button>
    <span class="zoom-level">{{ (canvasState.zoom * 100) | number:'1.0-0' }}%</span>
    <button 
      class="control-btn"
      (click)="onZoomOut()"
      title="Zoom Out"
    >
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
        <path d="M19 13H5v-2h14v2z"/>
      </svg>
    </button>
    <button 
      class="control-btn"
      (click)="onResetZoom()"
      title="Reset Zoom"
    >
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
      </svg>
    </button>
  </div>

  <!-- Drop Zone Indicator -->
  <div class="drop-zone-indicator" *ngIf="isDragOver">
    <div class="drop-zone-content">
      <div class="drop-icon">📍</div>
      <h3>Drop API Here</h3>
      <p>Release to create a new node</p>
    </div>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="canvasState.nodes.length === 0 && !isDragOver">
    <div class="empty-icon">🎯</div>
    <h3>Start Building Your Workflow</h3>
    <p>Drag nodes from the sidebar to create your integration workflow</p>
  </div>
</div>

<!-- Context Menu -->
<app-context-menu
  [visible]="contextMenuVisible"
  [position]="contextMenuPosition"
  [items]="contextMenuItems"
  (close)="onContextMenuClose()"
></app-context-menu>

<!-- Rename Dialog -->
<app-rename-dialog
  [visible]="showRenameDialog"
  [currentName]="nodeToRename?.name || ''"
  (close)="onRenameDialogClose()"
  (save)="onRenameDialogSave($event)"
></app-rename-dialog>